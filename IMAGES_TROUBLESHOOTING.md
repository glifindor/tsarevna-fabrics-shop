# Устранение проблем с изображениями товаров

## Описание проблемы
Изображения товаров не отображаются в каталоге (ошибка 404), но видны в админ панели. После перезагрузки PM2 изображения появляются.

## Внесенные изменения

### 1. Обновлен компонент ProductImage
- Добавлена тройная система fallback для загрузки изображений
- Сначала пытается загрузить как статический файл `/uploads/`
- При ошибке пробует API маршрут `/api/static/`
- При следующей ошибке пробует API маршрут `/api/uploads/`
- В конце показывает fallback изображение

### 2. Улучшено логирование
- Добавлено подробное логирование в API маршруты `/api/uploads/` и `/api/static/`
- Логирование показывает:
  - Запрашиваемый файл
  - Полный путь к файлу
  - Список файлов в папке uploads
  - Ошибки при загрузке

### 3. Уменьшено кеширование
- Кеширование статических файлов уменьшено с 1 часа до 1 минуты
- Это позволяет быстрее обновлять изображения

### 4. Добавлен API для очистки кеша
- Новый эндпоинт `/api/cache/clear` для принудительной очистки кеша
- Доступен только администраторам

### 5. Кнопка очистки кеша в админ панели
- Добавлена кнопка "Очистить кеш изображений" в админ панели
- Позволяет вручную обновить кеш без перезагрузки сервера

## Инструкции по использованию

### Если изображения не отображаются:

1. **В браузере разработчика** проверьте консоль на ошибки загрузки изображений
2. **В консоли сервера** проверьте логи API маршрутов
3. **В админ панели** нажмите кнопку "Очистить кеш изображений"
4. **Обновите страницу** каталога

### Диагностика через логи:
```bash
# Просмотр логов PM2
pm2 logs tsarevna-fabrics

# Или если используете systemd
journalctl -u your-service-name -f
```

### Проверка файлов в папке uploads:
```bash
ls -la public/uploads/
```

## Возможные причины проблемы

1. **Файл не сохранился** - проверьте логи загрузки файлов
2. **Проблема с правами доступа** - убедитесь, что папка uploads доступна для записи
3. **Кеширование Next.js** - используйте кнопку очистки кеша
4. **Проблема с путями** - проверьте правильность формирования URL
5. **Асинхронная запись файлов** - файл может не успеть записаться

## Мониторинг

Следите за логами в консоли браузера и сервера:
- Ошибки загрузки изображений
- Попытки fallback на API маршруты
- Успешные загрузки через API

## Если проблема повторяется

1. Проверьте, что файлы действительно сохраняются в `public/uploads/`
2. Убедитесь, что процесс записи файлов завершается успешно
3. Рассмотрите возможность использования внешнего хранилища (S3, CDN)
4. Добавьте задержку после загрузки файла перед отображением

## Техническая информация

- **Компонент изображений**: `src/components/ui/ProductImage.tsx`
- **API загрузки**: `src/app/api/upload/route.ts`
- **API статических файлов**: `src/app/api/static/[...path]/route.ts`, `src/app/api/uploads/[...path]/route.ts`
- **Конфигурация**: `next.config.ts`
- **Очистка кеша**: `src/app/api/cache/clear/route.ts` 